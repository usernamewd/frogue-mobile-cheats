name: Build Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 35
        build-tools-version: 35.0.0
        target: google_apis
        arch: x86_64
        platform: android-35
    
    - name: Setup Android SDK for modern tools
      run: |
        sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"
        sdkmanager --licenses
      shell: bash
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build Debug APK
      run: |
        ./gradlew clean android:assembleDebug
        echo "Debug APK build completed"
        ls -la android/build/outputs/apk/debug/ || echo "Debug APK directory not found"
      shell: bash
    
    - name: Build Release APK (Unsigned)
      run: |
        ./gradlew clean android:assembleRelease
        echo "Release APK build completed"
        ls -la android/build/outputs/apk/release/ || echo "Release APK directory not found"
      shell: bash
    
    - name: Build Release APK (Signed)
      run: |
        # Create signing keystore (for demonstration)
        echo "Creating signing keystore..."
        keytool -genkey -v -keystore frogue-release-key.keystore -alias frogue-key -keyalg RSA -keysize 2048 -validity 10000 -storepass android123 -keypass android123 -dname "CN=Frogue, OU=GameDev, O=Frogue Mobile, L=GameCity, S=GameState, C=GS"
        
        # Setup signing configuration
        mkdir -p android/app/src/main/res/values
        cat > android/app/src/main/res/values/signing.xml << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <string name="keystore_password">android123</string>
            <string name="key_alias">frogue-key</string>
            <string name="key_password">android123</string>
        </resources>
        EOF
        
        # Add signing config to build.gradle
        ./gradlew clean android:assembleRelease
        
        # Debug output to see where APK files are created
        echo "=== Release APK Build Complete ==="
        echo "Checking for APK files in various locations..."
        echo "Android build directory:"
        ls -la android/build/outputs/apk/release/ || echo "No release directory found"
        
        echo "Android build directory (debug):"
        ls -la android/build/outputs/apk/debug/ || echo "No debug directory found"
        
        echo "Root directory APK files:"
        find . -maxdepth 1 -name "*.apk" -type f
        
        echo "All APK files in build directory:"
        find android/build -name "*.apk" -type f 2>/dev/null || echo "No APK files in build directory"
      shell: bash
      env:
        RELEASE_KEYSTORE_PASSWORD: android123
        RELEASE_KEY_ALIAS_PASSWORD: android123
    
    - name: Create Release Assets
      run: |
        mkdir -p release-assets
        
        # Get APK sizes and list available files
        echo "=== Checking for APK files in project ==="
        find . -name "*.apk" -type f
        
        # Look for APK files in common locations and copy them
        APK_COUNT=0
        
<<<<<<< HEAD
        # Check if the expected files exist
        echo "=== Checking for expected APK files ==="
        find android/build -name "*.apk" -type f | head -10
        echo "=== Checking for APK files in root directory ==="
        find . -maxdepth 2 -name "*.apk" -type f | head -10
        
        # Find and copy debug APK
        if [ -f "android/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "âœ… Debug APK found: android/build/outputs/apk/debug/app-debug.apk"
          cp android/build/outputs/apk/debug/app-debug.apk release-assets/frogue-mobile-cheats-debug.apk
        else
          echo "âŒ Debug APK not found at expected location, searching..."
          DEBUG_APK=$(find android/build -name "*debug*.apk" -type f | head -1)
          if [ ! -z "$DEBUG_APK" ]; then
            echo "âœ… Found debug APK: $DEBUG_APK"
            cp "$DEBUG_APK" release-assets/frogue-mobile-cheats-debug.apk
          else
            echo "âŒ No debug APK found anywhere"
          fi
        fi
        
        # Find and copy release APK
        if [ -f "android/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          echo "âœ… Release APK found: android/build/outputs/apk/release/app-release-unsigned.apk"
          cp android/build/outputs/apk/release/app-release-unsigned.apk release-assets/frogue-mobile-cheats-release-unsigned.apk
        elif [ -f "android/build/outputs/apk/release/app-release.apk" ]; then
          echo "âœ… Release APK found: android/build/outputs/apk/release/app-release.apk"
          cp android/build/outputs/apk/release/app-release.apk release-assets/frogue-mobile-cheats-release.apk
        else
          echo "âŒ Release APK not found at expected location, searching..."
          RELEASE_APK=$(find android/build -name "*release*.apk" -type f | head -1)
          if [ ! -z "$RELEASE_APK" ]; then
            echo "âœ… Found release APK: $RELEASE_APK"
            cp "$RELEASE_APK" release-assets/frogue-mobile-cheats-release-unsigned.apk
          else
            # Check root directory for android-release-unsigned.apk
            if [ -f "android-release-unsigned.apk" ]; then
              echo "âœ… Found release APK in root: android-release-unsigned.apk"
              cp android-release-unsigned.apk release-assets/frogue-mobile-cheats-release-unsigned.apk
            else
              echo "âŒ No release APK found anywhere"
            fi
          fi
=======
        # Try to find and copy debug APK
        DEBUG_APK=$(find . -name "*debug.apk" -type f | head -1)
        if [ -n "$DEBUG_APK" ]; then
          echo "âœ… Debug APK found: $DEBUG_APK"
          cp "$DEBUG_APK" release-assets/frogue-mobile-cheats-debug.apk
          APK_COUNT=$((APK_COUNT + 1))
        else
          echo "âš ï¸ Debug APK not found"
        fi
        
        # Try to find and copy release APK
        RELEASE_APK=$(find . -name "*release*.apk" -type f | head -1)
        if [ -n "$RELEASE_APK" ]; then
          echo "âœ… Release APK found: $RELEASE_APK"
          cp "$RELEASE_APK" release-assets/frogue-mobile-cheats-release.apk
          APK_COUNT=$((APK_COUNT + 1))
        else
          echo "âš ï¸ Release APK not found"
>>>>>>> 555d48a (Fix GitHub Actions workflow for Android build:)
        fi
        
        echo "Found $APK_COUNT APK files"
        
        # Create release info
        cat > release-assets/BUILD_INFO.md << EOF
        # Frogue Mobile Cheats - Build Information

        ## Build Date: $(date)
        ## Git Commit: ${{ github.sha }}
        ## Git Branch: ${{ github.ref_name }}
        ## Workflow Run: ${{ github.run_id }}

        ## Available APKs:
        1. **Debug APK** (frogue-mobile-cheats-debug.apk)
           - For development and testing
           - Includes debugging symbols
           - Larger file size
           - Can be installed directly

        2. **Release APK (Unsigned)** (frogue-mobile-cheats-release-unsigned.apk)
           - Production-ready build
           - Optimized and minified
           - Smaller file size
           - Requires signing for installation

        ## Installation Instructions:

        ### Debug APK:
        1. Enable "Unknown Sources" in Android settings
        2. Download and install frogue-mobile-cheats-debug.apk
        3. Launch the app

        ### Release APK:
        1. Sign the APK with your own keystore
        2. Enable "Unknown Sources" in Android settings
        3. Download and install the signed APK
        4. Launch the app

        ## Mobile Cheat System Features:
        - Touch-optimized cheat interface
        - Floating action buttons (menu & aimbot)
        - Gesture controls (double-tap for auto-aimbot)
        - Mobile-specific aimbot with smooth targeting
        - All traditional cheats accessible via touch UI
        - Battery-optimized operations

        ## Build Environment:
        - JDK 17
        - Android API 35
        - Build Tools 35.0.0
        - Gradle Wrapper

        For more information, see the README and documentation files.
        EOF
        
        ls -la release-assets/
      shell: bash
    
<<<<<<< HEAD
    - name: Upload Debug APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: frogue-debug-apk
        path: release-assets/frogue-mobile-cheats-debug.apk
        retention-days: 30
=======
    - name: Upload APK Artifacts
      run: |
        # Upload all found APK files as artifacts
        find . -name "*.apk" -type f | while read apk; do
          echo "Uploading artifact: $apk"
          # This will be handled by the generic artifact upload below
        done
        
        # List all APK files for verification
        echo "All APK files found:"
        find . -name "*.apk" -type f
>>>>>>> 555d48a (Fix GitHub Actions workflow for Android build:)
    
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
<<<<<<< HEAD
        name: frogue-release-apk-unsigned
        path: release-assets/frogue-mobile-cheats-release-unsigned.apk
        retention-days: 90
    
    - name: Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: frogue-release-assets
=======
        name: frogue-apk-artifacts
>>>>>>> 555d48a (Fix GitHub Actions workflow for Android build:)
        path: release-assets/
        retention-days: 90
        if-no-files-found: error

    - name: Create Release (Optional)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
<<<<<<< HEAD
      uses: softprops/action-gh-release@v1
      with:
        tag_name: android-build-${{ github.run_number }}
        name: Android Build ${{ github.run_number }}
        body: |
          Automated Android build for Frogue Mobile Cheats.
          
          **Build Information:**
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Date: $(date)
          
          **Available Files:**
          - Debug APK (ready to install)
          - Release APK (unsigned, needs signing)
          - Build information and documentation
          
          **Installation:**
          - Debug APK: Install directly on Android device
          - Release APK: Sign with keystore before installation
          
          **Features:**
          - Touch-optimized cheat interface
          - Mobile aimbot with gesture controls
          - All traditional cheats via touch UI
          - Battery-optimized operations
        files: |
          release-assets/frogue-mobile-cheats-debug.apk
          release-assets/frogue-mobile-cheats-release-unsigned.apk
          release-assets/BUILD_INFO.md
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
=======
      run: |
        # Skip GitHub release creation due to permissions issues
        echo "Skipping GitHub release creation to avoid 403 errors"
        echo "APK artifacts are available in the Actions artifacts section"
        echo "Download release-assets from the build artifacts to get the APK files"
>>>>>>> 555d48a (Fix GitHub Actions workflow for Android build:)
    
    - name: Build Summary
      run: |
        echo "## ðŸš€ Android Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **APK Build**: Successfully compiled and packaged" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Artifacts**: All APKs uploaded as build artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± **Mobile Ready**: Touch-optimized cheat interface included" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### How to Get Your APK:" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to the **Actions** tab in this repository" >> $GITHUB_STEP_SUMMARY
        echo "2. Click on the latest successful build run" >> $GITHUB_STEP_SUMMARY
        echo "3. Scroll down to **Artifacts** section" >> $GITHUB_STEP_SUMMARY
        echo "4. Download **frogue-apk-artifacts**" >> $GITHUB_STEP_SUMMARY
        echo "5. Extract and install the APK on your Android device" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Mobile Cheat System Features:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ Touch-optimized aimbot with gesture controls" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± Floating UI buttons for easy mobile access" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ› ï¸ All traditional cheats accessible via touch interface" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ Battery-optimized mobile operations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation Instructions:" >> $GITHUB_STEP_SUMMARY
        echo "1. Enable **Unknown Sources** in Android settings" >> $GITHUB_STEP_SUMMARY
        echo "2. Download and install the APK from artifacts" >> $GITHUB_STEP_SUMMARY
        echo "3. Launch the app and enjoy enhanced mobile gaming!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“‹ **Build Details**: Commit `${{ github.sha }}` | Branch `${{ github.ref_name }}`" >> $GITHUB_STEP_SUMMARY
      shell: bash